<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•ç¯€äº¤æ›ç¦®ç‰©å¤§æœƒ ğŸ</title>
    
    <meta property="og:image" content="https://zyzy.dpdns.org/xmas-change/thumbnail.jpg">
    <meta property="og:title" content="ğŸ„ è–èª•ç¯€äº¤æ›ç¦®ç‰©å¤§æœƒ ğŸ">
    <meta property="og:description" content="ä¸€å¹´ä¸€åº¦çš„äº¤æ›ç¦®ç‰©é–‹å§‹å›‰ï¼å¿«ä¾†çœ‹çœ‹ä½ æŠ½åˆ°èª°ï¼çµ•å°å…¬å¹³ã€ä¸æœƒæŠ½åˆ°è‡ªå·±ã€‚">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --red: #D42426;
            --green: #2F5233;
            --gold: #F1D570;
            --cream: #F8F5E6;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--green);
            background-image: radial-gradient(circle at 50% 50%, #3a6b41 0%, #2F5233 100%);
            color: var(--cream);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; 
        }

        /* === å…¨åŸŸç‡ˆå…‰æ§åˆ¶å±¤ (æ ¸å¿ƒä¿®æ”¹) === */
        #light-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            /* é è¨­: æ¢å¾©è®Šäº®çš„é€Ÿåº¦å¿«ä¸€é» */
            transition: opacity 0.5s ease;
        }

        /* æ¨¡å¼ 1: æ¼¸é€²å¼èšå…‰ç‡ˆ (Spotlight) */
        /* é€™è£¡çš„ transition è¨­å®šç‚º 2.5sï¼Œé…åˆæŠ½çæ™‚é–“æ…¢æ…¢è®Šæš— */
        body.mode-spotlight #light-overlay {
            opacity: 1;
            /* ä¸­é–“æŒ–ç©ºçš„é»‘è‰²é®ç½© */
            background: radial-gradient(circle at center, transparent 120px, rgba(0,0,0,0.98) 250px);
            transition: opacity 2.5s ease-in-out; 
        }

        /* æ¨¡å¼ 2: å…¨é»‘ (Blackout) */
        body.mode-blackout #light-overlay {
            opacity: 1;
            background: #000;
            /* é—œç‡ˆè¦å¿«ï¼Œæ‰æœ‰ã€Œå•ªã€ä¸€è²çš„æ„Ÿè¦º */
            transition: background 0.1s, opacity 0.1s; 
        }

        /* ç•¶é€²å…¥å…¨é»‘æ¨¡å¼æ™‚ï¼Œå¼·åˆ¶éš±è—æ‰€æœ‰æ–‡å­—é¡¯ç¤ºå€ */
        body.mode-blackout #displayArea {
            opacity: 0 !important;
            transition: opacity 0.1s;
        }

        /* ================================= */

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
            z-index: 10; 
        }

        .decoration {
            font-family: 'Mountains of Christmas', cursive;
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 1rem;
        }

        h1 { margin: 0 0 1.5rem 0; font-size: 1.8rem; }

        .input-group { display: flex; gap: 10px; margin-bottom: 1rem; }
        input { flex: 1; padding: 10px; border-radius: 8px; border: none; outline: none; font-size: 1rem; }
        
        button { cursor: pointer; border: none; border-radius: 8px; padding: 10px 20px; font-size: 1rem; font-weight: bold; transition: transform 0.1s; }
        button:active { transform: scale(0.95); }
        .btn-add { background: var(--gold); color: var(--green); }
        .btn-start { background: var(--red); color: white; width: 100%; margin-top: 10px; font-size: 1.2rem; }
        
        .btn-draw { 
            background: var(--red); color: white; width: 100%; font-size: 1.5rem; padding: 15px; margin-top: 20px; 
            transition: opacity 1.5s; /* æŒ‰éˆ•ä¹Ÿè·Ÿè‘—æ…¢æ…¢è®Šæš— */
        }
        body.mode-spotlight .btn-draw { opacity: 0.2; }

        .btn-reset { background: transparent; border: 1px solid var(--cream); color: var(--cream); margin-top: 20px; font-size: 0.8rem; }

        .list-area { max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 1rem; text-align: left; }
        .tag { display: inline-block; background: var(--cream); color: var(--green); padding: 4px 8px; border-radius: 4px; margin: 4px; font-size: 0.9rem; }

        #game-section { display: none; }
        select { width: 100%; padding: 12px; border-radius: 8px; font-size: 1.1rem; margin-bottom: 10px; background: var(--cream); border: none; }

        .result-box {
            margin-top: 20px;
            min-height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            overflow: hidden;
        }

        .rolling-text {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--gold);
            white-space: nowrap;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1001; 
        }

        /* èšå…‰ç‡ˆæ¨¡å¼ä¸‹ï¼Œæ»¾å‹•æ–‡å­—é€æ¼¸è®Šäº®è®Šå¤§ */
        body.mode-spotlight .rolling-text {
            color: #fff;
            text-shadow: 0 0 20px var(--gold), 0 0 10px white;
            font-size: 3.2rem; 
        }

        .final-result {
            font-size: 3rem;
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
            z-index: 1001;
            text-shadow: 0 0 20px white, 0 0 40px var(--gold), 0 0 80px var(--red);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes flashScreen {
            0% { background-color: white; opacity: 1; }
            100% { background-color: transparent; opacity: 0; }
        }
        .flash-effect {
            animation: flashScreen 0.8s ease-out forwards;
            background: white; 
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .instruction { font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px; }

        .snowflake { position: fixed; top: -10px; color: #fff; font-size: 1em; opacity: 0.5; animation: fall linear infinite; z-index: -1; }
        @keyframes fall { to { transform: translateY(105vh); } }
    </style>
</head>
<body>

    <div id="light-overlay"></div>

    <script>
        for(let i=0; i<20; i++){
            let snow = document.createElement('div');
            snow.className = 'snowflake';
            snow.innerHTML = 'â„';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.animationDuration = Math.random() * 3 + 2 + 's';
            snow.style.fontSize = Math.random() * 10 + 10 + 'px';
            document.body.appendChild(snow);
        }
    </script>

    <div class="container">
        <div class="decoration">Merry Christmas</div>
        
        <div id="setup-section">
            <h1>ğŸ… åƒåŠ è€…åå–®è¨­å®š</h1>
            <div class="input-group">
                <input type="text" id="nameInput" placeholder="è¼¸å…¥åå­— (ä¾‹å¦‚: å°æ˜)" onkeypress="handleEnter(event)">
                <button class="btn-add" onclick="addName()">åŠ å…¥</button>
            </div>
            <div class="list-area" id="nameList"></div>
            <p style="font-size:0.8rem; color:#bbb;">ç›®å‰äººæ•¸: <span id="count">0</span></p>
            <button class="btn-start" onclick="startGame()">é–‹å§‹åˆ†é…ç¦®ç‰© ğŸ</button>
        </div>

        <div id="game-section">
            <h1>ğŸ èª°è¦æŠ½ç¦®ç‰©ï¼Ÿ</h1>
            <p class="instruction">è«‹é¸æ“‡ä½ çš„åå­—ï¼Œç„¶å¾ŒæŒ‰ä¸‹æŠ½çï¼</p>
            
            <select id="personSelect" onchange="resetDisplay()">
                <option value="" disabled selected>-- è«‹é¸æ“‡ä½ çš„åå­— --</option>
            </select>

            <div class="result-box">
                <div id="displayArea" class="rolling-text">?</div>
            </div>

            <button class="btn-draw" id="drawBtn" onclick="drawGift()">é–‹å§‹æŠ½ç</button>
            
            <div style="margin-top: 20px;">
                <button class="btn-reset" onclick="location.reload()">é‡æ–°é–‹å§‹ / é‡ç½®è³‡æ–™</button>
            </div>
        </div>
    </div>

    <script>
        let participants = [];
        let assignments = {}; 
        let hasDrawn = {};    

        function handleEnter(e) { if (e.key === 'Enter') addName(); }

        function addName() {
            const input = document.getElementById('nameInput');
            const name = input.value.trim();
            if (name && !participants.includes(name)) {
                participants.push(name);
                renderList();
                input.value = '';
            } else if (participants.includes(name)) {
                alert("é€™å€‹åå­—å·²ç¶“åœ¨åå–®å…§å›‰ï¼");
            }
        }

        function renderList() {
            const list = document.getElementById('nameList');
            const countSpan = document.getElementById('count');
            list.innerHTML = participants.map(p => `<span class="tag">${p}</span>`).join('');
            countSpan.innerText = participants.length;
        }

        function generateDerangement(names) {
            let shuffled;
            let isValid = false;
            while (!isValid) {
                shuffled = [...names].sort(() => Math.random() - 0.5);
                isValid = true;
                for (let i = 0; i < names.length; i++) {
                    if (names[i] === shuffled[i]) {
                        isValid = false;
                        break;
                    }
                }
            }
            let result = {};
            for (let i = 0; i < names.length; i++) {
                result[names[i]] = shuffled[i];
            }
            return result;
        }

        function startGame() {
            if (participants.length < 2) {
                alert("è‡³å°‘éœ€è¦ 2 å€‹äººæ‰èƒ½äº¤æ›ç¦®ç‰©å–”ï¼");
                return;
            }
            assignments = generateDerangement(participants);
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';
            const select = document.getElementById('personSelect');
            participants.forEach(p => {
                let opt = document.createElement('option');
                opt.value = p;
                opt.innerText = p;
                select.appendChild(opt);
            });
        }

        function resetDisplay() {
            document.body.classList.remove('mode-spotlight', 'mode-blackout');
            const overlay = document.getElementById('light-overlay');
            overlay.className = ''; 

            const display = document.getElementById('displayArea');
            display.innerHTML = "?";
            display.className = "rolling-text";
            display.style.opacity = '1';

            document.getElementById('drawBtn').disabled = false;
            document.getElementById('drawBtn').innerText = "é–‹å§‹æŠ½ç";
        }

        function drawGift() {
            const who = document.getElementById('personSelect').value;
            if (!who) return alert("è«‹å…ˆé¸æ“‡ä½ æ˜¯èª°ï¼");
            if (hasDrawn[who]) return alert("ä½ å·²ç¶“æŠ½éå›‰ï¼");

            const target = assignments[who];
            const display = document.getElementById('displayArea');
            const btn = document.getElementById('drawBtn');
            
            btn.disabled = true;
            
            // ã€1. å•Ÿå‹•æ¼¸é€²å¼èšå…‰ç‡ˆã€‘
            // CSS ä¸­è¨­å®šäº† 2.5s çš„ transitionï¼Œæ‰€ä»¥æœƒæ…¢æ…¢è®Šæš—
            document.body.classList.add('mode-spotlight');

            let counter = 0;
            let speed = 50; 
            let rollsBeforeBlackout = 30; // æ»¾å‹•æ¬¡æ•¸ï¼Œç¸½æ™‚é–“ç´„ 2-2.5 ç§’

            let tempNames = participants.filter(n => n !== who);
            if (tempNames.length < 5) tempNames = [...tempNames, ...tempNames, ...tempNames];
            
            function roll() {
                display.innerText = tempNames[Math.floor(Math.random() * tempNames.length)];
                counter++;
                
                if (counter < rollsBeforeBlackout) {
                    if (counter > rollsBeforeBlackout - 10) speed += 20; 
                    if (counter > rollsBeforeBlackout - 5) speed += 40;
                    setTimeout(roll, speed);
                } else {
                    // ã€2. é—œç‡ˆï¼šå…¨é»‘æ¨¡å¼ã€‘
                    enterBlackoutPhase();
                }
            }
            roll();

            function enterBlackoutPhase() {
                 // é€™è£¡ transition æœƒä¾æ“š CSS è®Šæˆ 0.1sï¼Œç¬é–“è®Šé»‘
                 document.body.classList.remove('mode-spotlight');
                 document.body.classList.add('mode-blackout');
                 
                 // åœé “ 0.8 ç§’
                 setTimeout(() => {
                     // ã€3. æ­æ›‰çµæœã€‘
                     showResultWithFlash(target);
                 }, 800);
            }
        }

        function showResultWithFlash(targetName) {
            const display = document.getElementById('displayArea');
            const overlay = document.getElementById('light-overlay');

            document.body.classList.remove('mode-blackout');
            
            // é–ƒå…‰ç‰¹æ•ˆ
            overlay.className = 'flash-effect';

            display.style.opacity = '1';
            display.innerText = "ğŸ " + targetName;
            display.className = "final-result";
            
            hasDrawn[document.getElementById('personSelect').value] = true;
            document.getElementById('drawBtn').innerText = "æŠ½çå®Œæˆ";

            fireConfetti();

            setTimeout(() => {
                overlay.className = '';
            }, 800);
        }

        function fireConfetti() {
            var count = 300;
            var defaults = { origin: { y: 0.7 } };
            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }
            fire(0.25, { spread: 26, startVelocity: 55, });
            fire(0.2, { spread: 60, });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45, });
        }
    </script>
</body>
</html>
