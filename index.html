<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•ç¯€äº¤æ›ç¦®ç‰©å¤§æœƒ ğŸ</title>
    
    <meta property="og:image" content="https://zyzy.dpdns.org/xmas-change/thumbnail.jpg">
    
    <meta property="og:title" content="ğŸ„ è–èª•ç¯€äº¤æ›ç¦®ç‰©å¤§æœƒ ğŸ">
    <meta property="og:description" content="ä¸€å¹´ä¸€åº¦çš„äº¤æ›ç¦®ç‰©é–‹å§‹å›‰ï¼å¿«ä¾†çœ‹çœ‹ä½ æŠ½åˆ°èª°ï¼çµ•å°å…¬å¹³ã€ä¸æœƒæŠ½åˆ°è‡ªå·±ã€‚">
    <meta property="og:type" content="website">
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --red: #D42426;
            --green: #2F5233;
            --gold: #F1D570;
            --cream: #F8F5E6;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--green);
            background-image: radial-gradient(circle at 50% 50%, #3a6b41 0%, #2F5233 100%);
            color: var(--cream);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }

        /* è£é£¾ç”¨çš„è–èª•å…ƒç´  */
        .decoration {
            font-family: 'Mountains of Christmas', cursive;
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 1rem;
        }

        h1 {
            margin: 0 0 1.5rem 0;
            font-size: 1.8rem;
        }

        /* è¼¸å…¥å€å¡Š */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: none;
            outline: none;
            font-size: 1rem;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: bold;
            transition: transform 0.1s, background 0.3s;
        }

        button:active {
            transform: scale(0.95);
        }

        .btn-add { background: var(--gold); color: var(--green); }
        .btn-start { background: var(--red); color: white; width: 100%; margin-top: 10px; font-size: 1.2rem; }
        .btn-draw { background: var(--red); color: white; width: 100%; font-size: 1.5rem; padding: 15px; margin-top: 20px; }
        .btn-reset { background: transparent; border: 1px solid var(--cream); color: var(--cream); margin-top: 20px; font-size: 0.8rem; }

        /* åƒåŠ è€…åˆ—è¡¨ */
        .list-area {
            max-height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 1rem;
            text-align: left;
        }

        .tag {
            display: inline-block;
            background: var(--cream);
            color: var(--green);
            padding: 4px 8px;
            border-radius: 4px;
            margin: 4px;
            font-size: 0.9rem;
        }

        /* æŠ½çå€å¡Š (é è¨­éš±è—) */
        #game-section { display: none; }

        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-size: 1.1rem;
            margin-bottom: 10px;
            background: var(--cream);
            border: none;
        }

        /* çµæœé¡¯ç¤ºç‰¹æ•ˆ */
        .result-box {
            margin-top: 20px;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢åå­—å¤ªé•·è·‘ç‰ˆ */
        }

        .rolling-text {
            font-size: 2rem;
            font-weight: bold;
            color: var(--gold);
            white-space: nowrap;
        }

        .final-result {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px var(--red);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
        }

        .instruction {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* é›ªèŠ±èƒŒæ™¯ */
        .snowflake {
            position: fixed;
            top: -10px;
            color: #fff;
            font-size: 1em;
            opacity: 0.8;
            animation: fall linear infinite;
            z-index: -1;
        }
        @keyframes fall {
            to { transform: translateY(105vh); }
        }
    </style>
</head>
<body>

    <script>
        for(let i=0; i<20; i++){
            let snow = document.createElement('div');
            snow.className = 'snowflake';
            snow.innerHTML = 'â„';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.animationDuration = Math.random() * 3 + 2 + 's';
            snow.style.fontSize = Math.random() * 10 + 10 + 'px';
            document.body.appendChild(snow);
        }
    </script>

    <div class="container">
        <div class="decoration">Merry Christmas</div>
        
        <div id="setup-section">
            <h1>ğŸ… åƒåŠ è€…åå–®è¨­å®š</h1>
            <div class="input-group">
                <input type="text" id="nameInput" placeholder="è¼¸å…¥åå­— (ä¾‹å¦‚: å°æ˜)" onkeypress="handleEnter(event)">
                <button class="btn-add" onclick="addName()">åŠ å…¥</button>
            </div>
            <div class="list-area" id="nameList">
                </div>
            <p style="font-size:0.8rem; color:#bbb;">ç›®å‰äººæ•¸: <span id="count">0</span></p>
            <button class="btn-start" onclick="startGame()">é–‹å§‹åˆ†é…ç¦®ç‰© ğŸ</button>
        </div>

        <div id="game-section">
            <h1>ğŸ èª°è¦æŠ½ç¦®ç‰©ï¼Ÿ</h1>
            <p class="instruction">è«‹é¸æ“‡ä½ çš„åå­—ï¼Œç„¶å¾ŒæŒ‰ä¸‹æŠ½çï¼</p>
            
            <select id="personSelect" onchange="resetDisplay()">
                <option value="" disabled selected>-- è«‹é¸æ“‡ä½ çš„åå­— --</option>
            </select>

            <div class="result-box">
                <div id="displayArea" class="rolling-text">?</div>
            </div>

            <button class="btn-draw" id="drawBtn" onclick="drawGift()">é–‹å§‹æŠ½ç</button>
            
            <div style="margin-top: 20px;">
                <button class="btn-reset" onclick="location.reload()">é‡æ–°é–‹å§‹ / é‡ç½®è³‡æ–™</button>
            </div>
        </div>
    </div>

    <script>
        let participants = [];
        let assignments = {}; // å„²å­˜ é…å°çµæœ { "å°æ˜": "å°è¯" }
        let hasDrawn = {};    // ç´€éŒ„èª°å·²ç¶“çœ‹éçµæœ

        // æŒ‰ Enter éµåŠ å…¥
        function handleEnter(e) {
            if (e.key === 'Enter') addName();
        }

        // åŠ å…¥åå–®
        function addName() {
            const input = document.getElementById('nameInput');
            const name = input.value.trim();
            if (name && !participants.includes(name)) {
                participants.push(name);
                renderList();
                input.value = '';
            } else if (participants.includes(name)) {
                alert("é€™å€‹åå­—å·²ç¶“åœ¨åå–®å…§å›‰ï¼");
            }
        }

        // æ¸²æŸ“åå–®
        function renderList() {
            const list = document.getElementById('nameList');
            const countSpan = document.getElementById('count');
            list.innerHTML = participants.map(p => `<span class="tag">${p}</span>`).join('');
            countSpan.innerText = participants.length;
        }

        // æ ¸å¿ƒæ¼”ç®—æ³•ï¼šç”¢ç”ŸéŒ¯æ’ (Derangement)
        function generateDerangement(names) {
            let shuffled;
            let isValid = false;
            while (!isValid) {
                shuffled = [...names].sort(() => Math.random() - 0.5);
                isValid = true;
                for (let i = 0; i < names.length; i++) {
                    if (names[i] === shuffled[i]) {
                        isValid = false;
                        break;
                    }
                }
            }
            let result = {};
            for (let i = 0; i < names.length; i++) {
                result[names[i]] = shuffled[i];
            }
            return result;
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            if (participants.length < 2) {
                alert("è‡³å°‘éœ€è¦ 2 å€‹äººæ‰èƒ½äº¤æ›ç¦®ç‰©å–”ï¼");
                return;
            }
            assignments = generateDerangement(participants);
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';
            const select = document.getElementById('personSelect');
            participants.forEach(p => {
                let opt = document.createElement('option');
                opt.value = p;
                opt.innerText = p;
                select.appendChild(opt);
            });
        }

        // é‡ç½®é¡¯ç¤ºå€åŸŸ
        function resetDisplay() {
            document.getElementById('displayArea').innerHTML = "?";
            document.getElementById('displayArea').className = "rolling-text";
            document.getElementById('drawBtn').disabled = false;
            document.getElementById('drawBtn').innerText = "é–‹å§‹æŠ½ç";
        }

        // åŸ·è¡ŒæŠ½çé‚è¼¯ (å·²æ›´æ–°å‹•ç•«é †æš¢åº¦)
        function drawGift() {
            const who = document.getElementById('personSelect').value;
            if (!who) {
                alert("è«‹å…ˆé¸æ“‡ä½ æ˜¯èª°ï¼");
                return;
            }
            if (hasDrawn[who]) {
                alert("ä½ å·²ç¶“æŠ½éå›‰ï¼");
                return;
            }

            const target = assignments[who];
            const display = document.getElementById('displayArea');
            const btn = document.getElementById('drawBtn');
            
            // é–‹å§‹å‹•ç•«æ•ˆæœ
            btn.disabled = true;
            let counter = 0;
            let speed = 40; // èµ·å§‹é€Ÿåº¦ç¨å¾®åŠ å¿«
            let maxCount = 35; // å¢åŠ æ»¾å‹•ç¸½æ¬¡æ•¸ï¼Œè®“éç¨‹æ›´è±å¯Œ

            // å»ºç«‹ä¸€å€‹å‡çš„æ»¾å‹•åå–® (ä¸å«è‡ªå·±)
            let tempNames = participants.filter(n => n !== who);
            // å¦‚æœäººæ•¸å¤ªå°‘ï¼Œè¤‡è£½å¹¾ä»½è®“æ»¾å‹•çœ‹èµ·ä¾†æ¯”è¼ƒå¤šæ¨£
            if (tempNames.length < 5) {
                tempNames = [...tempNames, ...tempNames, ...tempNames];
            }
            
            function roll() {
                // éš¨æ©Ÿé¡¯ç¤ºåå­—
                display.innerText = tempNames[Math.floor(Math.random() * tempNames.length)];
                
                counter++;
                if (counter < maxCount) {
                    // --- æ›´æ–°å¾Œçš„æ¸›é€Ÿé‚è¼¯ ---
                    // åœ¨æœ€å¾Œéšæ®µæ‰é–‹å§‹è®Šæ…¢ï¼Œä¸”è®Šæ…¢çš„å¹…åº¦æ¯”è¼ƒå¹³æ»‘
                    // ä¸æœƒåƒä¹‹å‰é‚£æ¨£çªç„¶å¡ä½
                    if (counter > maxCount - 10) speed += 10; 
                    if (counter > maxCount - 5) speed += 15;

                    setTimeout(roll, speed);
                } else {
                    // åœæ­¢ï¼Œé¡¯ç¤ºçµæœ
                    showResult(target);
                }
            }
            roll();
        }

        // é¡¯ç¤ºçµæœèˆ‡å½©å¸¶ç‰¹æ•ˆ
        function showResult(targetName) {
            const display = document.getElementById('displayArea');
            display.innerText = "ğŸ " + targetName;
            display.className = "final-result";
            
            hasDrawn[document.getElementById('personSelect').value] = true;
            document.getElementById('drawBtn').innerText = "æŠ½çå®Œæˆ";

            fireConfetti();
        }

        function fireConfetti() {
            var count = 200;
            var defaults = { origin: { y: 0.7 } };
            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }
            fire(0.25, { spread: 26, startVelocity: 55, });
            fire(0.2, { spread: 60, });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45, });
        }
    </script>
</body>
</html>
