<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ äº¤æ›ç¦®ç‰©å¤§æœƒ ğŸ</title>
    
    <meta property="og:image" content="https://zyzy.dpdns.org/xmas-change/thumbnail.jpg">
    <meta property="og:title" content="ğŸ„ äº¤æ›ç¦®ç‰©å¤§æœƒ ğŸ">
    <meta property="og:description" content="å¤©å ‚èˆ‡åœ°ç„ï¼Œä¸€éµåˆ‡æ›ï¼å¿«ä¾†çœ‹çœ‹ä½ æŠ½åˆ°ä»€éº¼ï¼">
    <meta property="og:type" content="website">

    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* === å¤©å ‚æ¨¡å¼ (é è¨­) === */
        :root {
            --bg-grad-start: #3a6b41;
            --bg-grad-end: #2F5233;
            --bg-color: #2F5233;
            --text-color: #F8F5E6;
            --accent-color: #F1D570; /* é‡‘è‰² */
            --btn-color: #D42426;     /* ç´…è‰² */
            --btn-text: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0,0,0,0.5);
            --tag-bg: #F8F5E6;
            --tag-text: #2F5233;
        }

        /* === åœ°ç„æ¨¡å¼ (Bad Mode) === */
        body.bad-mode {
            --bg-grad-start: #2c003e; /* æš—ç´« */
            --bg-grad-end: #1a0024;   /* æ·±é»‘ç´« */
            --bg-color: #1a0024;
            --text-color: #e0e0e0;
            --accent-color: #adff2f;  /* æ¯’ç¶ è‰² */
            --btn-color: #5d4037;     /* å¤§ä¾¿è‰²/æ·±è¤ */
            --btn-text: #adff2f;
            --glass-bg: rgba(0, 0, 0, 0.4);
            --shadow: #000;
            --tag-bg: #444;
            --tag-text: #adff2f;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(circle at 50% 50%, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden; 
            transition: background 1s ease; /* æ¨¡å¼åˆ‡æ›æ¼¸è®Š */
        }

        /* === å…¨åŸŸç‡ˆå…‰æ§åˆ¶å±¤ === */
        #light-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        /* æ¨¡å¼ 1: æ¼¸é€²å¼èšå…‰ç‡ˆ */
        body.mode-spotlight #light-overlay {
            opacity: 1;
            background: radial-gradient(circle at center, transparent 120px, rgba(0,0,0,0.98) 250px);
            transition: opacity 2.5s ease-in-out; 
        }

        /* æ¨¡å¼ 2: å…¨é»‘ */
        body.mode-blackout #light-overlay {
            opacity: 1;
            background: #000;
            transition: background 0.1s, opacity 0.1s; 
        }
        body.mode-blackout #displayArea { opacity: 0 !important; transition: opacity 0.1s; }

        /* ================================= */

        .container {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 2px solid var(--accent-color);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px var(--shadow);
            position: relative;
            z-index: 10; 
            transition: border 0.5s, background 0.5s;
        }

        /* åˆ‡æ›æ¨¡å¼æŒ‰éˆ• */
        .mode-switch {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 20;
        }
        .mode-switch:hover { background: rgba(0,0,0,0.5); }

        .decoration {
            font-family: 'Mountains of Christmas', cursive;
            font-size: 3rem;
            color: var(--accent-color);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 1rem;
        }

        h1 { margin: 0 0 1.5rem 0; font-size: 1.8rem; }

        .input-group { display: flex; gap: 10px; margin-bottom: 1rem; }
        input { flex: 1; padding: 10px; border-radius: 8px; border: none; outline: none; font-size: 1rem; }
        
        button { cursor: pointer; border: none; border-radius: 8px; padding: 10px 20px; font-size: 1rem; font-weight: bold; transition: all 0.3s; }
        button:active { transform: scale(0.95); }
        
        .btn-add { background: var(--accent-color); color: var(--bg-color); }
        .btn-start { background: var(--btn-color); color: var(--btn-text); width: 100%; margin-top: 10px; font-size: 1.2rem; }
        
        .btn-draw { 
            background: var(--btn-color); 
            color: var(--btn-text); 
            width: 100%; 
            font-size: 1.5rem; 
            padding: 15px; 
            margin-top: 20px; 
        }
        
        .btn-draw:disabled {
            background-color: #888 !important; /* é–å®šæ™‚çµ±ä¸€ç°è‰² */
            color: #ccc;
            cursor: not-allowed;
            transform: none;
            opacity: 0.8; 
        }
        body.mode-spotlight .btn-draw { opacity: 0.2; }

        .btn-reset { background: transparent; border: 1px solid var(--text-color); color: var(--text-color); margin-top: 20px; font-size: 0.8rem; }

        .list-area { max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 1rem; text-align: left; }
        .tag { display: inline-block; background: var(--tag-bg); color: var(--tag-text); padding: 4px 8px; border-radius: 4px; margin: 4px; font-size: 0.9rem; }

        #game-section { display: none; }
        select { width: 100%; padding: 12px; border-radius: 8px; font-size: 1.1rem; margin-bottom: 10px; background: #fff; border: none; }

        .result-box {
            margin-top: 20px;
            min-height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            overflow: hidden;
        }

        .rolling-text {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            white-space: nowrap;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1001; 
        }

        body.mode-spotlight .rolling-text {
            color: #fff;
            text-shadow: 0 0 20px var(--accent-color), 0 0 10px white;
            font-size: 3.2rem; 
        }

        .final-result {
            font-size: 3rem;
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
            z-index: 1001;
            text-shadow: 0 0 20px white, 0 0 40px var(--accent-color), 0 0 80px var(--btn-color);
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .next-prompt {
            margin-top: 15px;
            font-size: 1rem;
            color: var(--accent-color);
            font-weight: bold;
            min-height: 1.5em;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes flashScreen { 0% { background-color: white; opacity: 1; } 100% { background-color: transparent; opacity: 0; } }
        .flash-effect { animation: flashScreen 0.8s ease-out forwards; background: white; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }

        .instruction { font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px; }
        .snowflake { position: fixed; top: -10px; color: #fff; font-size: 1em; opacity: 0.5; animation: fall linear infinite; z-index: -1; pointer-events: none;}
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
    </style>
</head>
<body>

    <div id="light-overlay"></div>
    
    <div id="snow-container"></div>

    <div class="container">
        <button class="mode-switch" onclick="toggleMode()">ğŸ˜ˆ åˆ‡æ›åœ°ç„æ¨¡å¼</button>

        <div class="decoration" id="main-title">Merry Christmas</div>
        
        <div id="setup-section">
            <h1 id="setup-title">ğŸ… åƒåŠ è€…åå–®è¨­å®š</h1>
            <div class="input-group">
                <input type="text" id="nameInput" placeholder="è¼¸å…¥åå­— (ä¾‹å¦‚: å°æ˜)" onkeypress="handleEnter(event)">
                <button class="btn-add" onclick="addName()">åŠ å…¥</button>
            </div>
            <div class="list-area" id="nameList"></div>
            <p style="font-size:0.8rem; opacity: 0.7;">ç›®å‰äººæ•¸: <span id="count">0</span></p>
            <button class="btn-start" onclick="startGame()">é–‹å§‹åˆ†é…ç¦®ç‰© ğŸ</button>
        </div>

        <div id="game-section">
            <h1>ğŸ èª°è¦æŠ½ç¦®ç‰©ï¼Ÿ</h1>
            <p class="instruction">è«‹é¸æ“‡ä½ çš„åå­—ï¼Œç„¶å¾ŒæŒ‰ä¸‹æŠ½çï¼</p>
            
            <select id="personSelect" onchange="resetDisplay()">
                <option value="" disabled selected>-- è«‹é¸æ“‡ä½ çš„åå­— --</option>
            </select>

            <div class="result-box">
                <div id="displayArea" class="rolling-text">?</div>
            </div>

            <button class="btn-draw" id="drawBtn" onclick="drawGift()">é–‹å§‹æŠ½ç</button>
            
            <div id="promptArea" class="next-prompt"></div>
            
            <div style="margin-top: 20px;">
                <button class="btn-reset" onclick="location.reload()">é‡æ–°é–‹å§‹ / é‡ç½®è³‡æ–™</button>
            </div>
        </div>
    </div>

    <script>
        let participants = [];
        let assignments = {}; 
        let hasDrawn = {};
        let isBadMode = false;

        // åˆå§‹åŒ–é›ªèŠ±
        generateSnowflakes('â„');

        function toggleMode() {
            isBadMode = !isBadMode;
            const body = document.body;
            const btn = document.querySelector('.mode-switch');
            const mainTitle = document.getElementById('main-title');
            const setupTitle = document.getElementById('setup-title');

            if (isBadMode) {
                body.classList.add('bad-mode');
                btn.innerText = "ğŸ‘¼ åˆ‡æ›å¤©å ‚æ¨¡å¼";
                mainTitle.innerText = "Hell Christmas";
                setupTitle.innerText = "ğŸ˜ˆ çŠ§ç‰²è€…åå–®è¨­å®š";
                generateSnowflakes('ğŸ’©');
            } else {
                body.classList.remove('bad-mode');
                btn.innerText = "ğŸ˜ˆ åˆ‡æ›åœ°ç„æ¨¡å¼";
                mainTitle.innerText = "Merry Christmas";
                setupTitle.innerText = "ğŸ… åƒåŠ è€…åå–®è¨­å®š";
                generateSnowflakes('â„');
            }
            
            // å¦‚æœåœ¨éŠæˆ²ä¸­åˆ‡æ›ï¼Œé‡æ–°æ•´ç†é¡¯ç¤ºï¼ˆæ›´æ–°åœ–ç¤ºï¼‰
            if (document.getElementById('game-section').style.display === 'block') {
                resetDisplay();
            }
        }

        function generateSnowflakes(char) {
            const container = document.getElementById('snow-container');
            container.innerHTML = ''; // æ¸…ç©º
            for(let i=0; i<20; i++){
                let snow = document.createElement('div');
                snow.className = 'snowflake';
                snow.innerHTML = char;
                snow.style.left = Math.random() * 100 + 'vw';
                snow.style.animationDuration = Math.random() * 3 + 2 + 's';
                snow.style.fontSize = Math.random() * 10 + 10 + 'px';
                container.appendChild(snow);
            }
        }

        function handleEnter(e) { if (e.key === 'Enter') addName(); }

        function addName() {
            const input = document.getElementById('nameInput');
            const name = input.value.trim();
            if (name && !participants.includes(name)) {
                participants.push(name);
                renderList();
                input.value = '';
            } else if (participants.includes(name)) {
                alert("é€™å€‹åå­—å·²ç¶“åœ¨åå–®å…§å›‰ï¼");
            }
        }

        function renderList() {
            const list = document.getElementById('nameList');
            const countSpan = document.getElementById('count');
            list.innerHTML = participants.map(p => `<span class="tag">${p}</span>`).join('');
            countSpan.innerText = participants.length;
        }

        function generateDerangement(names) {
            let shuffled;
            let isValid = false;
            while (!isValid) {
                shuffled = [...names].sort(() => Math.random() - 0.5);
                isValid = true;
                for (let i = 0; i < names.length; i++) {
                    if (names[i] === shuffled[i]) {
                        isValid = false;
                        break;
                    }
                }
            }
            let result = {};
            for (let i = 0; i < names.length; i++) {
                result[names[i]] = shuffled[i];
            }
            return result;
        }

        function startGame() {
            if (participants.length < 2) {
                alert("è‡³å°‘éœ€è¦ 2 å€‹äººæ‰èƒ½äº¤æ›ç¦®ç‰©å–”ï¼");
                return;
            }
            assignments = generateDerangement(participants);
            document.getElementById('setup-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';
            const select = document.getElementById('personSelect');
            participants.forEach(p => {
                let opt = document.createElement('option');
                opt.value = p;
                opt.innerText = p;
                select.appendChild(opt);
            });
        }

        function resetDisplay() {
            document.body.classList.remove('mode-spotlight', 'mode-blackout');
            const overlay = document.getElementById('light-overlay');
            overlay.className = ''; 

            const select = document.getElementById('personSelect');
            const display = document.getElementById('displayArea');
            const btn = document.getElementById('drawBtn');
            const prompt = document.getElementById('promptArea');

            const who = select.value;
            
            // é è¨­é‡ç½®ç‹€æ…‹
            display.className = "rolling-text";
            display.style.opacity = '1';
            prompt.innerText = "";

            // åˆ¤æ–·è©²ä½¿ç”¨è€…æ˜¯å¦å·²æŠ½é
            if (who && hasDrawn[who]) {
                // === åŠŸèƒ½ 1ï¼šé¡¯ç¤ºèˆŠçš„æŠ½ççµæœ ===
                const giftIcon = isBadMode ? "ğŸ’© " : "ğŸ ";
                const result = assignments[who];
                
                display.innerText = giftIcon + result;
                display.className = "final-result"; // å¥—ç”¨çµæœæ¨£å¼
                
                btn.disabled = true;
                btn.innerText = "æ­¤äººå·²æŠ½é";
                prompt.innerText = "âš ï¸ ä½ å·²ç¶“æŠ½éäº†ï¼Œè«‹ä¸è¦å¤ªè²ªå¿ƒï¼";
            } else {
                // å°šæœªæŠ½é
                display.innerText = "?";
                btn.disabled = false;
                btn.innerText = "é–‹å§‹æŠ½ç";
            }
        }

        function drawGift() {
            const who = document.getElementById('personSelect').value;
            if (!who) return alert("è«‹å…ˆé¸æ“‡ä½ æ˜¯èª°ï¼");
            if (hasDrawn[who]) return alert("ä½ å·²ç¶“æŠ½éå›‰ï¼");

            const target = assignments[who];
            const display = document.getElementById('displayArea');
            const btn = document.getElementById('drawBtn');
            
            btn.disabled = true;
            
            document.body.classList.add('mode-spotlight');

            let counter = 0;
            let speed = 50; 
            let rollsBeforeBlackout = 30;

            let tempNames = participants.filter(n => n !== who);
            if (tempNames.length < 5) tempNames = [...tempNames, ...tempNames, ...tempNames];
            
            function roll() {
                display.innerText = tempNames[Math.floor(Math.random() * tempNames.length)];
                counter++;
                
                if (counter < rollsBeforeBlackout) {
                    if (counter > rollsBeforeBlackout - 10) speed += 20; 
                    if (counter > rollsBeforeBlackout - 5) speed += 40;
                    setTimeout(roll, speed);
                } else {
                    enterBlackoutPhase();
                }
            }
            roll();

            function enterBlackoutPhase() {
                 document.body.classList.remove('mode-spotlight');
                 document.body.classList.add('mode-blackout');
                 
                 setTimeout(() => {
                     showResultWithFlash(target);
                 }, 800);
            }
        }

        function showResultWithFlash(targetName) {
            const display = document.getElementById('displayArea');
            const overlay = document.getElementById('light-overlay');
            const btn = document.getElementById('drawBtn');
            const prompt = document.getElementById('promptArea');

            document.body.classList.remove('mode-blackout');
            overlay.className = 'flash-effect';

            display.style.opacity = '1';
            
            // æ ¹æ“šæ¨¡å¼é¡¯ç¤ºä¸åŒåœ–ç¤º
            const giftIcon = isBadMode ? "ğŸ’£ " : "ğŸ ";
            display.innerText = giftIcon + targetName;
            display.className = "final-result";
            
            hasDrawn[document.getElementById('personSelect').value] = true;
            
            btn.innerText = "æŠ½çå®Œæˆ";
            prompt.innerText = "ğŸ‰ æ­å–œï¼è«‹æ›ä¸‹ä¸€ä½ï¼Œåœ¨ä¸Šæ–¹é¸å–®åˆ‡æ›åå­—â¸œ(à¹‘âƒ™âƒ˜ËŠá—œË‹à¹‘âƒ™âƒ˜)â¸";

            fireConfetti();

            setTimeout(() => {
                overlay.className = '';
            }, 800);
        }

        function fireConfetti() {
            var count = 300;
            var defaults = { origin: { y: 0.7 } };
            // å¦‚æœæ˜¯åœ°ç„æ¨¡å¼ï¼Œå¯ä»¥è€ƒæ…®æŠŠå½©å¸¶é¡è‰²è®Šæ€ªä¸€é»ï¼Œé€™è£¡ç¶­æŒåŸæ¨£æ¯”è¼ƒç¹½ç´›
            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }
            fire(0.25, { spread: 26, startVelocity: 55, });
            fire(0.2, { spread: 60, });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45, });
        }
    </script>
</body>
</html>
